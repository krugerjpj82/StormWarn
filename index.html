<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Real-time weather warnings and forecasts for South Africa">
    <meta name="theme-color" content="#0ea5e9">
    <link rel="manifest" id="manifest-placeholder">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect fill='%230ea5e9' width='180' height='180'/%3E%3Ctext x='50%25' y='50%25' font-size='100' font-weight='bold' fill='white' text-anchor='middle' dy='.3em'%3E‚ö†%3C/text%3E%3C/svg%3E">
    <script>
        // Create manifest dynamically
        const manifest = {
            "name": "StormWarn - Weather Warnings for South Africa",
            "short_name": "StormWarn",
            "description": "Real-time weather warnings and forecasts for South Africa with severe weather alerts",
            "start_url": "/",
            "display": "standalone",
            "background_color": "#f8f7f5",
            "theme_color": "#0ea5e9",
            "orientation": "portrait-primary",
            "icons": [
                {
                    "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect fill='%230ea5e9' width='192' height='192'/%3E%3Ctext x='50%25' y='50%25' font-size='120' font-weight='bold' fill='white' text-anchor='middle' dy='.3em'%3E‚ö†%3C/text%3E%3C/svg%3E",
                    "sizes": "192x192",
                    "type": "image/svg+xml",
                    "purpose": "any maskable"
                },
                {
                    "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect fill='%230ea5e9' width='512' height='512'/%3E%3Ctext x='50%25' y='50%25' font-size='300' font-weight='bold' fill='white' text-anchor='middle' dy='.3em'%3E‚ö†%3C/text%3E%3C/svg%3E",
                    "sizes": "512x512",
                    "type": "image/svg+xml",
                    "purpose": "any maskable"
                }
            ],
            "categories": ["weather", "utilities", "lifestyle"],
            "screenshots": []
        };
        
        const stringManifest = JSON.stringify(manifest);
        const blob = new Blob([stringManifest], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        document.getElementById('manifest-placeholder').setAttribute('href', manifestURL);
    </script>
    <title>StormWarn - Weather Warnings for South Africa</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: #f8f7f5;
            color: #1a1a1a;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .header-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .header {
                flex-wrap: wrap;
            }
            
            .header-buttons {
                width: 100%;
                justify-content: space-between;
            }
            
            .install-btn, .notifications-btn {
                flex: 1;
                min-width: 0;
                font-size: 0.85rem;
                padding: 0.6rem 0.8rem;
                white-space: nowrap;
            }
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .location {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        .temperature {
            font-size: 4rem;
            font-weight: 800;
            margin: 1rem 0;
        }
        
        .condition {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .weather-icon {
            font-size: 3rem;
        }
        
        .details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }
        
        .detail {
            padding: 1rem;
            background: #f8f7f5;
            border-radius: 8px;
        }
        
        .detail-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .detail-value {
            font-size: 1.2rem;
            font-weight: 600;
            margin-top: 0.25rem;
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
        }
        
        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e5e5e5;
            border-top-color: #0ea5e9;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error {
            text-align: center;
            padding: 2rem;
            color: #dc2626;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            background: #0ea5e9;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 1rem;
        }
        
        .btn:hover {
            background: #0284c7;
        }
        
        .search-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .search-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #0ea5e9;
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            margin-top: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }
        
        .search-results.active {
            display: block;
        }
        
        .search-result {
            padding: 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .search-result:hover {
            background: #f8f9fa;
        }
        
        .search-result:last-child {
            border-bottom: none;
        }
        
        .result-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .result-location {
            font-size: 0.9rem;
            color: #666;
        }
        
        .search-wrapper {
            position: relative;
            flex: 1;
        }
        
        .btn-secondary {
            padding: 0.75rem 1.5rem;
            background: white;
            color: #1a1a1a;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .btn-secondary:hover {
            background: #f8f9fa;
        }
        
        .btn-secondary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .saved-locations {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }
        
        .saved-location {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .saved-location:hover {
            border-color: #0ea5e9;
            background: #f0f9ff;
        }
        
        .saved-location.active {
            background: #0ea5e9;
            color: white;
            border-color: #0ea5e9;
        }
        
        .remove-location {
            margin-left: 0.25rem;
            cursor: pointer;
            font-weight: bold;
        }
        
        .remove-location:hover {
            color: #dc2626;
        }
        
        .saved-locations-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #666;
            margin-bottom: 0.5rem;
        }
        
        .share-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: #25D366;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            margin-top: 1.5rem;
            transition: background 0.2s;
        }
        
        .share-btn:hover {
            background: #20ba5a;
        }
        
        .share-btn svg {
            width: 20px;
            height: 20px;
            fill: white;
        }
        
        .install-btn {
            display: none;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: #0ea5e9;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            margin-left: auto;
        }
        
        .install-btn:hover {
            background: #0284c7;
        }
        
        .install-btn.show {
            display: inline-flex;
        }
        
        .notifications-btn {
            display: none;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: #f97316;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            margin-left: 0.5rem;
        }
        
        .notifications-btn:hover {
            background: #ea580c;
        }
        
        .notifications-btn.show {
            display: inline-flex;
        }
        
        .notifications-btn.enabled {
            background: #22c55e;
        }
        
        .notifications-btn.enabled:hover {
            background: #16a34a;
        }
        
        .notifications-status {
            display: none;
            padding: 1rem;
            background: #fff7ed;
            border: 2px solid #f97316;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .notifications-status.show {
            display: block;
        }
        
        .notifications-status.enabled {
            background: #f0fdf4;
            border-color: #22c55e;
        }
        
        .share-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #f0f0f0;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .hourly-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: #8b5cf6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: background 0.2s;
        }
        
        .hourly-btn:hover {
            background: #7c3aed;
        }
        
        .warnings-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .warnings-header {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .warning-item {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid;
        }
        
        .warning-item:last-child {
            margin-bottom: 0;
        }
        
        .warning-red {
            background: #fee;
            border-color: #dc2626;
        }
        
        .warning-orange {
            background: #ffedd5;
            border-color: #f97316;
        }
        
        .warning-yellow {
            background: #fef9c3;
            border-color: #eab308;
        }
        
        .warning-level {
            font-weight: 700;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }
        
        .warning-red .warning-level {
            color: #dc2626;
        }
        
        .warning-orange .warning-level {
            color: #f97316;
        }
        
        .warning-yellow .warning-level {
            color: #eab308;
        }
        
        .warning-type {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        
        .warning-message {
            color: #666;
            line-height: 1.5;
        }
        
        .no-warnings {
            text-align: center;
            padding: 2rem;
            color: #22c55e;
        }
        
        .no-warnings-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }
        
        .forecast-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .forecast-header {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
        }
        
        .forecast-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .forecast-day {
            display: grid;
            grid-template-columns: 100px 60px 1fr 120px 120px;
            gap: 1rem;
            align-items: center;
            padding: 1rem;
            background: #f8f7f5;
            border-radius: 8px;
        }
        
        .forecast-day.today {
            background: #e0f2fe;
            border: 2px solid #0ea5e9;
        }
        
        .forecast-date {
            font-weight: 600;
        }
        
        .forecast-day.today .forecast-date {
            color: #0ea5e9;
            font-weight: 700;
        }
        
        .forecast-icon-day {
            font-size: 2rem;
            text-align: center;
        }
        
        .forecast-condition {
            color: #666;
        }
        
        .forecast-temp {
            font-weight: 600;
        }
        
        .forecast-temp-high {
            color: #dc2626;
        }
        
        .forecast-temp-low {
            color: #0ea5e9;
        }
        
        .forecast-precip {
            color: #0ea5e9;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .forecast-day {
                grid-template-columns: 1fr;
                gap: 0.5rem;
                text-align: center;
            }
            
            .forecast-icon-day {
                font-size: 3rem;
            }
        }
        
        .hourly-forecast {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            border-left: 3px solid #0ea5e9;
        }
        
        .hourly-forecast.show {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 1000px;
            }
        }
        
        .hourly-header {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: #0ea5e9;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .hourly-list {
            display: grid;
            gap: 0.75rem;
        }
        
        .hourly-item {
            display: grid;
            grid-template-columns: 80px 50px 1fr 80px 80px;
            gap: 1rem;
            align-items: center;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .hourly-item.current {
            background: #e0f2fe;
            border: 2px solid #0ea5e9;
            font-weight: 600;
        }
        
        .hourly-time {
            font-weight: 600;
            color: #1a1a1a;
        }
        
        .hourly-icon {
            font-size: 1.5rem;
            text-align: center;
        }
        
        .hourly-condition {
            color: #666;
            font-size: 0.9rem;
        }
        
        .hourly-temp {
            font-weight: 600;
            color: #1a1a1a;
        }
        
        .hourly-details {
            font-size: 0.85rem;
            color: #666;
        }
        
        .forecast-day.today {
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .forecast-day.today:hover {
            background: #dbeafe;
        }
        
        .expand-icon {
            margin-left: auto;
            font-size: 1.2rem;
            transition: transform 0.3s;
        }
        
        .expand-icon.expanded {
            transform: rotate(180deg);
        }
        
        @media (max-width: 768px) {
            .hourly-item {
                grid-template-columns: 1fr;
                text-align: center;
                gap: 0.5rem;
            }
            
            .hourly-icon {
                font-size: 2rem;
            }
        }
        
        .radar-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .radar-header {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .radar-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .radar-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .radar-btn:hover {
            border-color: #0ea5e9;
            background: #f0f9ff;
        }
        
        .radar-btn.active {
            background: #0ea5e9;
            color: white;
            border-color: #0ea5e9;
        }
        
        .radar-container {
            position: relative;
            width: 100%;
            height: 500px;
            border-radius: 8px;
            overflow: hidden;
            background: #f8f9fa;
        }
        
        .radar-map {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 8px;
        }
        
        .radar-legend {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: white;
            padding: 0.75rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            font-size: 0.85rem;
        }
        
        .radar-legend-title {
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .radar-legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }
        
        .radar-legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }
        
        .radar-info {
            margin-top: 1rem;
            padding: 1rem;
            background: #f0f9ff;
            border-left: 4px solid #0ea5e9;
            border-radius: 4px;
            font-size: 0.9rem;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .radar-container {
                height: 400px;
            }
            
            .radar-legend {
                bottom: 5px;
                right: 5px;
                font-size: 0.75rem;
                padding: 0.5rem;
            }
            
            .radar-controls {
                flex-direction: column;
            }
            
            .radar-btn {
                width: 100%;
            }
        }
        
        /* Modal Popup Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9998;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-overlay.show {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            z-index: 9999;
            animation: slideUp 0.3s ease;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 2px solid #f0f0f0;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
            border-radius: 12px 12px 0 0;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .modal-close {
            background: #f0f0f0;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: all 0.2s;
        }
        
        .modal-close:hover {
            background: #e0e0e0;
            transform: scale(1.1);
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-hourly-list {
            display: grid;
            gap: 0.75rem;
        }
        
        .modal-hourly-item {
            display: grid;
            grid-template-columns: 100px 60px 1fr 100px 120px;
            gap: 1rem;
            align-items: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            transition: background 0.2s;
        }
        
        .modal-hourly-item:hover {
            background: #e9ecef;
        }
        
        .modal-hourly-item.current {
            background: #e0f2fe;
            border: 2px solid #0ea5e9;
            font-weight: 600;
        }
        
        .modal-hour-time {
            font-weight: 600;
            font-size: 1.1rem;
            color: #1a1a1a;
        }
        
        .modal-hour-icon {
            font-size: 2rem;
            text-align: center;
        }
        
        .modal-hour-condition {
            color: #666;
        }
        
        .modal-hour-temp {
            font-weight: 700;
            font-size: 1.2rem;
            color: #1a1a1a;
        }
        
        .modal-hour-details {
            color: #666;
            font-size: 0.9rem;
        }
        
        /* Offline Indicator */
        .offline-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #ef4444;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            display: none;
            animation: slideUpNotif 0.3s ease;
        }
        
        .offline-indicator.show {
            display: block;
        }
        
        .offline-indicator.online {
            background: #10b981;
        }
        
        @keyframes slideUpNotif {
            from {
                transform: translateX(-50%) translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        
        .cache-status {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            color: #0369a1;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .cache-status.hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .modal-content {
                max-height: 85vh;
                margin: 1rem;
            }
            
            .modal-title {
                font-size: 1.2rem;
            }
            
            .modal-hourly-item {
                grid-template-columns: 1fr;
                text-align: center;
                gap: 0.5rem;
            }
            
            .modal-hour-icon {
                font-size: 2.5rem;
            }
            
            .modal-hour-time {
                font-size: 1rem;
            }
            
            .modal-hour-temp {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">‚ö†Ô∏è StormWarn</div>
            <div class="header-buttons">
                <button class="install-btn" id="installBtn" onclick="installPWA()">
                    üì± Add to Home Screen
                </button>
                <button class="notifications-btn" id="notificationsBtn" onclick="toggleNotifications()">
                    üîî Enable Alerts
                </button>
            </div>
        </div>
        
        <div class="notifications-status" id="notificationsStatus"></div>
        
        <div class="search-bar">
            <div class="search-wrapper">
                <input 
                    type="text" 
                    class="search-input" 
                    id="searchInput"
                    placeholder="Search for a location..."
                    autocomplete="off"
                />
                <div class="search-results" id="searchResults"></div>
            </div>
            <button class="btn-secondary" id="saveBtn" onclick="saveLocation()" disabled>
                ‚≠ê Save Location
            </button>
        </div>
        
        <div id="savedLocationsContainer" style="display: none;">
            <div class="saved-locations-label">üìç Saved Locations</div>
            <div class="saved-locations" id="savedLocations"></div>
        </div>
        
        <div id="app">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading weather data...</p>
            </div>
        </div>
    </div>
    
    <!-- Offline Indicator -->
    <div class="offline-indicator" id="offlineIndicator">
        üì° Offline - Using cached data
    </div>
    
    <script>
        console.log('StormWarn: App starting...');
        
        const app = document.getElementById('app');
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        const saveBtn = document.getElementById('saveBtn');
        const savedLocationsContainer = document.getElementById('savedLocationsContainer');
        const savedLocationsDiv = document.getElementById('savedLocations');
        const offlineIndicator = document.getElementById('offlineIndicator');
        
        let currentLocation = null;
        let savedLocations = [];
        let searchTimeout = null;
        let deferredPrompt = null;
        let notificationPermission = 'default';
        let currentRadarLayer = 'precipitation';
        
        // Network status monitoring
        function updateOnlineStatus() {
            if (navigator.onLine) {
                offlineIndicator.textContent = '‚úÖ Back online - Refreshing data';
                offlineIndicator.classList.add('online');
                offlineIndicator.classList.add('show');
                
                // Hide after 3 seconds
                setTimeout(() => {
                    offlineIndicator.classList.remove('show');
                    setTimeout(() => {
                        offlineIndicator.classList.remove('online');
                    }, 300);
                }, 3000);
                
                // Refresh weather if we have current location
                if (currentLocation) {
                    console.log('StormWarn: Back online, refreshing weather data');
                    loadWeather(currentLocation.lat, currentLocation.lon, currentLocation.name);
                }
            } else {
                offlineIndicator.textContent = 'üì° Offline - Using cached data (valid 24 hours)';
                offlineIndicator.classList.remove('online');
                offlineIndicator.classList.add('show');
                console.log('StormWarn: Offline mode - cached data will be used');
            }
        }
        
        // Listen for online/offline events
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        
        // Check initial status
        if (!navigator.onLine) {
            updateOnlineStatus();
        }
        
        // Switch radar layer
        function switchRadarLayer(layer) {
            currentRadarLayer = layer;
            
            // Update button states
            document.querySelectorAll('.radar-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update radar map
            updateRadarMap();
        }
        
        // Update radar map with current layer and location
        function updateRadarMap() {
            if (!currentLocation) return;
            
            const radarFrame = document.getElementById('radarMap');
            if (!radarFrame) return;
            
            const { lat, lon } = currentLocation;
            const zoom = 8; // Good zoom level for regional view
            
            // Map our layer names to Windy overlay names
            const layerMap = {
                'rain': 'rain',
                'clouds': 'clouds',
                'wind': 'wind',
                'temp': 'temp',
                'lightning': 'lightning'
            };
            
            const windyLayer = layerMap[currentRadarLayer] || 'rain';
            
            // Build Windy embed URL with specific layer
            let windyUrl = `https://embed.windy.com/embed2.html?lat=${lat}&lon=${lon}&detailLat=${lat}&detailLon=${lon}&width=100%&height=500&zoom=${zoom}&level=surface&overlay=${windyLayer}&product=ecmwf&menu=&message=&marker=&calendar=now&pressure=&type=map&location=coordinates&detail=&metricWind=km%2Fh&metricTemp=%C2%B0C&radarRange=-1`;
            
            radarFrame.src = windyUrl;
        }
        
        // Detect if user is on iOS
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        }
        
        // Detect if user is on Android
        function isAndroid() {
            return /Android/.test(navigator.userAgent);
        }
        
        // Check if running as installed PWA
        function isStandalone() {
            return window.matchMedia('(display-mode: standalone)').matches || 
                   window.navigator.standalone || 
                   document.referrer.includes('android-app://');
        }
        
        // Show install button based on platform
        function showInstallButton() {
            const installBtn = document.getElementById('installBtn');
            
            // Don't show if already installed
            if (isStandalone()) {
                console.log('StormWarn: Already running as installed app');
                return;
            }
            
            // For iOS - always show with manual instructions
            if (isIOS()) {
                installBtn.textContent = 'üì± Install App';
                installBtn.classList.add('show');
                console.log('StormWarn: iOS detected - showing install button');
                return;
            }
            
            // For Android/Desktop - show if prompt available
            if (deferredPrompt) {
                installBtn.classList.add('show');
                console.log('StormWarn: Install prompt available - showing button');
            }
        }
        
        // Check notification permission on load
        if ('Notification' in window) {
            notificationPermission = Notification.permission;
            updateNotificationButton();
        }
        
        // Check if install button should be shown
        setTimeout(() => {
            showInstallButton();
        }, 1000); // Small delay to ensure DOM is ready
        
        // Update notification button state
        function updateNotificationButton() {
            const btn = document.getElementById('notificationsBtn');
            const status = document.getElementById('notificationsStatus');
            
            if (!('Notification' in window) || !('serviceWorker' in navigator)) {
                // Browser doesn't support notifications
                return;
            }
            
            btn.classList.add('show');
            
            if (notificationPermission === 'granted') {
                btn.textContent = '‚úÖ Alerts Enabled';
                btn.classList.add('enabled');
                status.classList.add('show', 'enabled');
                status.innerHTML = `
                    <strong>‚úÖ Severe Weather Alerts Enabled</strong><br>
                    <span style="font-size: 0.9rem; color: #166534;">You'll receive notifications for severe weather in your area</span>
                `;
            } else if (notificationPermission === 'denied') {
                btn.textContent = 'üîï Alerts Blocked';
                btn.disabled = true;
                btn.style.opacity = '0.6';
                btn.style.cursor = 'not-allowed';
                status.classList.add('show');
                status.innerHTML = `
                    <strong>üîï Notifications Blocked</strong><br>
                    <span style="font-size: 0.9rem; color: #9a3412;">To enable: Go to browser settings ‚Üí Site permissions ‚Üí Notifications ‚Üí Allow</span>
                `;
            } else {
                btn.textContent = 'üîî Enable Alerts';
                btn.classList.remove('enabled');
            }
        }
        
        // Toggle notifications
        async function toggleNotifications() {
            if (!('Notification' in window)) {
                alert('Your browser does not support notifications');
                return;
            }
            
            if (notificationPermission === 'denied') {
                alert('Notifications are blocked. Please enable them in your browser settings.');
                return;
            }
            
            if (notificationPermission === 'granted') {
                // Already enabled, show info
                alert('Severe weather alerts are enabled!\n\nYou will receive notifications when:\n‚Ä¢ Severe weather warnings are issued\n‚Ä¢ Dangerous conditions detected\n‚Ä¢ Your saved locations are affected');
                return;
            }
            
            try {
                // Request permission
                const permission = await Notification.requestPermission();
                notificationPermission = permission;
                updateNotificationButton();
                
                if (permission === 'granted') {
                    // Send test notification
                    showNotification(
                        'StormWarn Alerts Enabled ‚úÖ',
                        'You\'ll now receive severe weather alerts for your area',
                        'üîî'
                    );
                    
                    // Subscribe to push notifications
                    subscribeToPush();
                }
            } catch (error) {
                console.error('Error requesting notification permission:', error);
                alert('Failed to enable notifications. Please try again.');
            }
        }
        
        // Show notification
        function showNotification(title, body, icon) {
            if (notificationPermission !== 'granted') return;
            
            // Check if service worker is ready
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                navigator.serviceWorker.ready.then((registration) => {
                    registration.showNotification(title, {
                        body: body,
                        icon: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Crect fill="%230ea5e9" width="100" height="100"/%3E%3Ctext x="50%25" y="50%25" font-size="60" font-weight="bold" fill="white" text-anchor="middle" dy=".3em"%3E' + icon + '%3C/text%3E%3C/svg%3E',
                        badge: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 96 96"%3E%3Ccircle fill="%230ea5e9" cx="48" cy="48" r="48"/%3E%3Ctext x="50%25" y="50%25" font-size="48" font-weight="bold" fill="white" text-anchor="middle" dy=".3em"%3E‚ö†%3C/text%3E%3C/svg%3E',
                        vibrate: [200, 100, 200],
                        tag: 'stormwarn-alert',
                        requireInteraction: true,
                        data: {
                            url: window.location.href
                        }
                    });
                });
            } else {
                // Fallback to basic notification
                new Notification(title, {
                    body: body,
                    icon: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Crect fill="%230ea5e9" width="100" height="100"/%3E%3Ctext x="50%25" y="50%25" font-size="60" font-weight="bold" fill="white" text-anchor="middle" dy=".3em"%3E' + icon + '%3C/text%3E%3C/svg%3E'
                });
            }
        }
        
        // Subscribe to push notifications (placeholder for backend integration)
        async function subscribeToPush() {
            if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                console.log('Push notifications not supported');
                return;
            }
            
            try {
                const registration = await navigator.serviceWorker.ready;
                
                // Check if already subscribed
                const existingSubscription = await registration.pushManager.getSubscription();
                if (existingSubscription) {
                    console.log('Already subscribed to push notifications');
                    // TODO: Send subscription to backend
                    return;
                }
                
                // Note: Push notifications require a backend server with VAPID keys
                // For now, we'll use local notifications based on weather conditions
                console.log('Push subscription ready - backend integration needed for production');
                
                // Store user preference
                localStorage.setItem('stormwarn_notifications_enabled', 'true');
                
            } catch (error) {
                console.error('Failed to subscribe to push:', error);
            }
        }
        
        // Check for severe weather and send notifications
        function checkSevereWeather(warnings) {
            if (notificationPermission !== 'granted') return;
            if (!localStorage.getItem('stormwarn_notifications_enabled')) return;
            
            // Check if we already notified recently (don't spam)
            const lastNotification = localStorage.getItem('stormwarn_last_notification');
            const now = Date.now();
            if (lastNotification && (now - parseInt(lastNotification)) < 3600000) {
                // Less than 1 hour since last notification
                return;
            }
            
            // Filter for moderate to severe warnings (Level 4+)
            const severeWarnings = warnings.filter(w => {
                const level = parseInt(w.level.match(/\d+/)[0]);
                return level >= 4;
            });
            
            if (severeWarnings.length === 0) return;
            
            // Send notification for most severe warning
            const mostSevere = severeWarnings[0];
            const location = currentLocation ? currentLocation.name : 'your area';
            
            showNotification(
                `‚ö†Ô∏è ${mostSevere.level} - ${location}`,
                mostSevere.type + '\n' + mostSevere.message.substring(0, 100) + '...',
                '‚ö†Ô∏è'
            );
            
            // Update last notification time
            localStorage.setItem('stormwarn_last_notification', now.toString());
        }
        
        // PWA Install functionality
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('StormWarn: PWA install prompt available');
            // Prevent the mini-infobar from appearing on mobile
            e.preventDefault();
            // Store the event so it can be triggered later
            deferredPrompt = e;
            // Show the install button
            showInstallButton();
        });
        
        // Function to install PWA
        function installPWA() {
            // iOS-specific instructions
            if (isIOS()) {
                const message = isStandalone() 
                    ? 'App is already installed on your home screen!'
                    : 'To install StormWarn on iOS:\n\n' +
                      '1. Tap the Share button (‚¨ÜÔ∏è)\n' +
                      '2. Scroll down\n' +
                      '3. Tap "Add to Home Screen"\n' +
                      '4. Tap "Add"\n\n' +
                      'You\'ll then have instant access to weather alerts!';
                
                alert(message);
                return;
            }
            
            // Android/Desktop - use native prompt
            if (!deferredPrompt) {
                console.log('StormWarn: Install prompt not available');
                
                // Fallback instructions for browsers that don't support beforeinstallprompt
                if (isAndroid()) {
                    alert('To install StormWarn:\n\n1. Tap the menu (‚ãÆ) in your browser\n2. Tap "Add to Home screen" or "Install app"\n3. Tap "Add" or "Install"');
                } else {
                    alert('To install StormWarn:\n\n1. Click the install icon in your browser address bar\n2. Or check your browser menu for "Install" option');
                }
                return;
            }
            
            // Show the install prompt
            deferredPrompt.prompt();
            
            // Wait for the user to respond to the prompt
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('StormWarn: User accepted PWA install');
                } else {
                    console.log('StormWarn: User dismissed PWA install');
                }
                // Clear the deferredPrompt
                deferredPrompt = null;
                // Hide the install button
                const installBtn = document.getElementById('installBtn');
                if (installBtn) {
                    installBtn.classList.remove('show');
                }
            });
        }
        
        // Hide install button when app is installed
        window.addEventListener('appinstalled', () => {
            console.log('StormWarn: PWA installed successfully');
            const installBtn = document.getElementById('installBtn');
            if (installBtn) {
                installBtn.classList.remove('show');
            }
            deferredPrompt = null;
        });
        
        // Register service worker for offline capability and 24-hour access
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Create enhanced service worker inline
                const swCode = `
                    const CACHE_NAME = 'stormwarn-v2.0';
                    const RUNTIME_CACHE = 'stormwarn-runtime';
                    const API_CACHE = 'stormwarn-api';
                    const RADAR_CACHE = 'stormwarn-radar';
                    const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
                    const RADAR_CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 hours for radar
                    
                    // URLs to cache immediately on install
                    const urlsToCache = [
                        '/',
                        '/index.html'
                    ];
                    
                    // Windy radar assets to pre-cache
                    const radarAssets = [
                        'https://embed.windy.com/embed2.html',
                        'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js'
                    ];
                    
                    // Install event - cache core files
                    self.addEventListener('install', (event) => {
                        console.log('[SW] Installing service worker v2.0 with radar caching...');
                        event.waitUntil(
                            Promise.all([
                                caches.open(CACHE_NAME).then((cache) => {
                                    console.log('[SW] Caching core files');
                                    return cache.addAll(urlsToCache);
                                }),
                                caches.open(RADAR_CACHE).then((cache) => {
                                    console.log('[SW] Pre-caching radar assets');
                                    return Promise.allSettled(
                                        radarAssets.map(url => 
                                            fetch(url, { mode: 'no-cors' })
                                                .then(response => cache.put(url, response))
                                                .catch(err => console.log('[SW] Failed to cache:', url))
                                        )
                                    );
                                })
                            ]).then(() => self.skipWaiting())
                        );
                    });
                    
                    // Activate event - clean up old caches
                    self.addEventListener('activate', (event) => {
                        console.log('[SW] Activating service worker...');
                        const cacheWhitelist = [CACHE_NAME, RUNTIME_CACHE, API_CACHE, RADAR_CACHE];
                        event.waitUntil(
                            caches.keys().then((cacheNames) => {
                                return Promise.all(
                                    cacheNames.map((cacheName) => {
                                        if (!cacheWhitelist.includes(cacheName)) {
                                            console.log('[SW] Deleting old cache:', cacheName);
                                            return caches.delete(cacheName);
                                        }
                                    })
                                );
                            }).then(() => self.clients.claim())
                        );
                    });
                    
                    // Fetch event - serve from cache with network fallback
                    self.addEventListener('fetch', (event) => {
                        const { request } = event;
                        const url = new URL(request.url);
                        
                        // Handle API requests specially (weather data)
                        if (url.hostname === 'api.open-meteo.com' || 
                            url.hostname === 'api.bigdatacloud.net' ||
                            url.hostname === 'geocoding-api.open-meteo.com') {
                            event.respondWith(handleAPIRequest(request));
                            return;
                        }
                        
                        // Handle Windy radar iframe and assets
                        if (url.hostname === 'embed.windy.com' || 
                            url.hostname.includes('windy.com') ||
                            url.hostname.includes('windycdn') ||
                            (url.hostname.includes('cloudflare') && url.pathname.includes('three.js'))) {
                            event.respondWith(handleRadarRequest(request));
                            return;
                        }
                        
                        // Handle app shell (HTML, CSS, JS)
                        event.respondWith(handleAppShellRequest(request));
                    });
                    
                    // Handle app shell with cache-first strategy
                    async function handleAppShellRequest(request) {
                        try {
                            // Try cache first
                            const cachedResponse = await caches.match(request);
                            if (cachedResponse) {
                                console.log('[SW] Serving from cache:', request.url);
                                return cachedResponse;
                            }
                            
                            // Network fallback
                            console.log('[SW] Fetching from network:', request.url);
                            const networkResponse = await fetch(request);
                            
                            // Cache the new response
                            if (networkResponse && networkResponse.status === 200) {
                                const cache = await caches.open(RUNTIME_CACHE);
                                cache.put(request, networkResponse.clone());
                            }
                            
                            return networkResponse;
                        } catch (error) {
                            console.log('[SW] Fetch failed, serving from cache:', error);
                            
                            // Try to serve from cache as last resort
                            const cachedResponse = await caches.match(request);
                            if (cachedResponse) {
                                return cachedResponse;
                            }
                            
                            // Return offline page if available
                            return new Response('Offline - Please check your connection', {
                                status: 503,
                                statusText: 'Service Unavailable'
                            });
                        }
                    }
                    
                    // Handle API requests with network-first, cache fallback (24-hour expiry)
                    async function handleAPIRequest(request) {
                        try {
                            // Try network first for fresh data
                            console.log('[SW] Fetching API data from network:', request.url);
                            const networkResponse = await fetch(request);
                            
                            if (networkResponse && networkResponse.status === 200) {
                                // Clone and cache the response with timestamp
                                const cache = await caches.open(API_CACHE);
                                const responseToCache = networkResponse.clone();
                                
                                // Add timestamp header
                                const headers = new Headers(responseToCache.headers);
                                headers.append('sw-cache-time', Date.now().toString());
                                
                                const cachedResponse = new Response(responseToCache.body, {
                                    status: responseToCache.status,
                                    statusText: responseToCache.statusText,
                                    headers: headers
                                });
                                
                                await cache.put(request, cachedResponse);
                                console.log('[SW] Cached API response:', request.url);
                            }
                            
                            return networkResponse;
                        } catch (error) {
                            console.log('[SW] Network failed, checking cache:', error);
                            
                            // Network failed, try cache
                            const cachedResponse = await caches.match(request);
                            
                            if (cachedResponse) {
                                // Check if cache is still valid (within 24 hours)
                                const cacheTime = cachedResponse.headers.get('sw-cache-time');
                                const now = Date.now();
                                
                                if (cacheTime && (now - parseInt(cacheTime)) < CACHE_DURATION) {
                                    console.log('[SW] Serving valid cached API data:', request.url);
                                    return cachedResponse;
                                } else {
                                    console.log('[SW] Cache expired for:', request.url);
                                    // Still serve expired cache if offline
                                    return cachedResponse;
                                }
                            }
                            
                            // No cache available
                            console.log('[SW] No cache available for:', request.url);
                            return new Response(JSON.stringify({
                                error: 'offline',
                                message: 'No internet connection and no cached data available'
                            }), {
                                status: 503,
                                headers: { 'Content-Type': 'application/json' }
                            });
                        }
                    }
                    
                    // Handle Windy radar with intelligent caching (24-hour cache)
                    async function handleRadarRequest(request) {
                        const url = new URL(request.url);
                        
                        try {
                            // Try network first for live radar
                            console.log('[SW] Fetching radar from network:', request.url);
                            const networkResponse = await fetch(request);
                            
                            if (networkResponse && networkResponse.status === 200) {
                                // Cache radar assets and tiles
                                const cache = await caches.open(RADAR_CACHE);
                                const responseToCache = networkResponse.clone();
                                
                                // Add timestamp for radar data
                                const headers = new Headers(responseToCache.headers);
                                headers.append('sw-radar-cache-time', Date.now().toString());
                                
                                const cachedResponse = new Response(responseToCache.body, {
                                    status: responseToCache.status,
                                    statusText: responseToCache.statusText,
                                    headers: headers
                                });
                                
                                await cache.put(request, cachedResponse);
                                console.log('[SW] Cached radar asset:', request.url);
                            }
                            
                            return networkResponse;
                        } catch (error) {
                            console.log('[SW] Radar network failed, checking cache:', error);
                            
                            // Network failed, try cache
                            const cachedResponse = await caches.match(request);
                            
                            if (cachedResponse) {
                                // Check cache age
                                const cacheTime = cachedResponse.headers.get('sw-radar-cache-time');
                                const now = Date.now();
                                
                                if (cacheTime && (now - parseInt(cacheTime)) < RADAR_CACHE_DURATION) {
                                    console.log('[SW] Serving cached radar (valid):', request.url);
                                } else {
                                    console.log('[SW] Serving cached radar (expired but offline):', request.url);
                                }
                                
                                return cachedResponse;
                            }
                            
                            // No cache, return offline placeholder for iframe
                            if (url.pathname.includes('embed2.html')) {
                                console.log('[SW] No radar cache, returning offline message');
                                return new Response(\`
                                    <!DOCTYPE html>
                                    <html>
                                    <head>
                                        <meta charset="UTF-8">
                                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                                        <style>
                                            body {
                                                margin: 0;
                                                font-family: Arial, sans-serif;
                                                display: flex;
                                                align-items: center;
                                                justify-content: center;
                                                height: 100vh;
                                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                                color: white;
                                            }
                                            .offline-message {
                                                text-align: center;
                                                padding: 2rem;
                                            }
                                            .offline-icon {
                                                font-size: 4rem;
                                                margin-bottom: 1rem;
                                            }
                                            h2 {
                                                margin: 0 0 1rem 0;
                                                font-size: 1.5rem;
                                            }
                                            p {
                                                margin: 0;
                                                opacity: 0.9;
                                                font-size: 1rem;
                                            }
                                        </style>
                                    </head>
                                    <body>
                                        <div class="offline-message">
                                            <div class="offline-icon">üåê</div>
                                            <h2>Radar Offline</h2>
                                            <p>Live radar requires internet connection</p>
                                            <p style="margin-top: 1rem; font-size: 0.9rem;">Other weather data available from cache</p>
                                        </div>
                                    </body>
                                    </html>
                                \`, {
                                    status: 200,
                                    headers: { 'Content-Type': 'text/html' }
                                });
                            }
                            
                            // For other radar assets, return error
                            return new Response('Radar asset unavailable offline', {
                                status: 503,
                                headers: { 'Content-Type': 'text/plain' }
                            });
                        }
                    }
                    
                    // Handle notification clicks
                    self.addEventListener('notificationclick', (event) => {
                        event.notification.close();
                        
                        // Open the app
                        event.waitUntil(
                            clients.matchAll({ type: 'window', includeUncontrolled: true })
                                .then((clientList) => {
                                    // Check if app is already open
                                    for (let client of clientList) {
                                        if (client.url === '/' && 'focus' in client) {
                                            return client.focus();
                                        }
                                    }
                                    // Open new window
                                    if (clients.openWindow) {
                                        return clients.openWindow('/');
                                    }
                                })
                        );
                    });
                    
                    // Handle push notifications (for future backend integration)
                    self.addEventListener('push', (event) => {
                        const data = event.data ? event.data.json() : {};
                        const title = data.title || '‚ö†Ô∏è StormWarn Alert';
                        const options = {
                            body: data.body || 'Severe weather alert',
                            icon: data.icon || '/icon-192.png',
                            badge: '/badge-96.png',
                            vibrate: [200, 100, 200],
                            data: data,
                            requireInteraction: true,
                            tag: 'stormwarn-alert',
                            actions: [
                                { action: 'view', title: 'View Details' },
                                { action: 'dismiss', title: 'Dismiss' }
                            ]
                        };
                        
                        event.waitUntil(
                            self.registration.showNotification(title, options)
                        );
                    });
                    
                    // Background sync for offline actions
                    self.addEventListener('sync', (event) => {
                        console.log('[SW] Background sync triggered:', event.tag);
                        if (event.tag === 'sync-weather-data') {
                            event.waitUntil(syncWeatherData());
                        } else if (event.tag === 'sync-radar-data') {
                            event.waitUntil(syncRadarData());
                        }
                    });
                    
                    // Sync weather data when back online
                    async function syncWeatherData() {
                        console.log('[SW] Syncing weather data...');
                        const cache = await caches.open(API_CACHE);
                        const keys = await cache.keys();
                        
                        // Remove entries older than 24 hours
                        const now = Date.now();
                        for (const request of keys) {
                            const response = await cache.match(request);
                            const cacheTime = response.headers.get('sw-cache-time');
                            
                            if (cacheTime && (now - parseInt(cacheTime)) > CACHE_DURATION) {
                                await cache.delete(request);
                                console.log('[SW] Removed expired weather cache entry');
                            }
                        }
                    }
                    
                    // Sync radar data when back online
                    async function syncRadarData() {
                        console.log('[SW] Syncing radar data...');
                        const cache = await caches.open(RADAR_CACHE);
                        const keys = await cache.keys();
                        
                        // Remove entries older than 24 hours
                        const now = Date.now();
                        let cleaned = 0;
                        
                        for (const request of keys) {
                            const response = await cache.match(request);
                            const cacheTime = response.headers.get('sw-radar-cache-time');
                            
                            if (cacheTime && (now - parseInt(cacheTime)) > RADAR_CACHE_DURATION) {
                                await cache.delete(request);
                                cleaned++;
                            }
                        }
                        
                        console.log(\`[SW] Cleaned \${cleaned} expired radar cache entries\`);
                    }
                    
                    // Periodic background sync (Chrome only, future feature)
                    self.addEventListener('periodicsync', (event) => {
                        if (event.tag === 'update-weather') {
                            console.log('[SW] Periodic sync: updating weather');
                            event.waitUntil(syncWeatherData());
                        } else if (event.tag === 'update-radar') {
                            console.log('[SW] Periodic sync: updating radar');
                            event.waitUntil(syncRadarData());
                        }
                    });
                    
                    console.log('[SW] Service Worker v2.0 loaded with radar caching enabled');
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then((registration) => {
                        console.log('StormWarn: Service Worker registered successfully');
                        console.log('StormWarn: Offline mode enabled - 24-hour weather + radar caching active');
                        
                        // Check for updates every hour
                        setInterval(() => {
                            registration.update();
                        }, 60 * 60 * 1000);
                        
                        // Trigger initial radar cache if online
                        if (navigator.onLine) {
                            console.log('StormWarn: Pre-caching radar assets...');
                        }
                    })
                    .catch((error) => {
                        console.error('StormWarn: Service Worker registration failed:', error);
                    });
            });
        }
        
        // Load saved locations from localStorage
        function loadSavedLocations() {
            const saved = localStorage.getItem('stormwarn_locations');
            if (saved) {
                savedLocations = JSON.parse(saved);
                renderSavedLocations();
            }
        }
        
        // Save locations to localStorage
        function saveSavedLocations() {
            localStorage.setItem('stormwarn_locations', JSON.stringify(savedLocations));
            renderSavedLocations();
        }
        
        // Render saved locations
        function renderSavedLocations() {
            if (savedLocations.length === 0) {
                savedLocationsContainer.style.display = 'none';
                return;
            }
            
            savedLocationsContainer.style.display = 'block';
            savedLocationsDiv.innerHTML = savedLocations.map((loc, index) => {
                const isActive = currentLocation && 
                    Math.abs(currentLocation.lat - loc.lat) < 0.01 && 
                    Math.abs(currentLocation.lon - loc.lon) < 0.01;
                return `
                    <div class="saved-location ${isActive ? 'active' : ''}" onclick="loadSavedLocation(${index})">
                        <span>${loc.name}</span>
                        <span class="remove-location" onclick="event.stopPropagation(); removeSavedLocation(${index})">√ó</span>
                    </div>
                `;
            }).join('');
        }
        
        // Save current location
        function saveLocation() {
            if (!currentLocation) return;
            
            // Check if already saved
            const exists = savedLocations.some(loc => 
                Math.abs(loc.lat - currentLocation.lat) < 0.01 && 
                Math.abs(loc.lon - currentLocation.lon) < 0.01
            );
            
            if (exists) {
                alert('This location is already saved!');
                return;
            }
            
            savedLocations.push({
                name: currentLocation.name,
                lat: currentLocation.lat,
                lon: currentLocation.lon
            });
            
            saveSavedLocations();
            updateSaveButton();
        }
        
        // Load a saved location
        function loadSavedLocation(index) {
            const loc = savedLocations[index];
            loadWeather(loc.lat, loc.lon, loc.name);
        }
        
        // Remove a saved location
        function removeSavedLocation(index) {
            savedLocations.splice(index, 1);
            saveSavedLocations();
            updateSaveButton();
        }
        
        // Update save button state
        function updateSaveButton() {
            if (!currentLocation) {
                saveBtn.disabled = true;
                return;
            }
            
            const exists = savedLocations.some(loc => 
                Math.abs(loc.lat - currentLocation.lat) < 0.01 && 
                Math.abs(loc.lon - currentLocation.lon) < 0.01
            );
            
            if (exists) {
                saveBtn.disabled = true;
                saveBtn.textContent = '‚úì Saved';
            } else {
                saveBtn.disabled = false;
                saveBtn.textContent = '‚≠ê Save Location';
            }
        }
        
        // Search for locations
        async function searchLocation(query) {
            if (!query.trim()) {
                searchResults.classList.remove('active');
                return;
            }
            
            try {
                const res = await fetch(
                    `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=5&language=en&format=json`
                );
                const data = await res.json();
                
                if (!data.results || data.results.length === 0) {
                    searchResults.innerHTML = '<div class="search-result">No results found</div>';
                    searchResults.classList.add('active');
                    return;
                }
                
                searchResults.innerHTML = data.results.map(result => `
                    <div class="search-result" onclick="selectLocation(${result.latitude}, ${result.longitude}, '${result.name.replace(/'/g, "\\'")}')">
                        <div class="result-name">${result.name}</div>
                        <div class="result-location">${result.admin1 || ''} ${result.country || ''}</div>
                    </div>
                `).join('');
                searchResults.classList.add('active');
            } catch (error) {
                console.error('Search failed:', error);
            }
        }
        
        // Select a search result
        function selectLocation(lat, lon, name) {
            searchResults.classList.remove('active');
            searchInput.value = '';
            loadWeather(lat, lon, name);
        }
        
        // Setup search input
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchLocation(e.target.value);
            }, 300);
        });
        
        // Close search results when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-wrapper')) {
                searchResults.classList.remove('active');
            }
        });
        
        // Toggle hourly forecast display
        function toggleHourlyForecast() {
            const hourlyDiv = document.getElementById('hourlyForecast');
            const expandIcon = document.getElementById('expandIcon');
            
            if (hourlyDiv.classList.contains('show')) {
                hourlyDiv.classList.remove('show');
                expandIcon.classList.remove('expanded');
            } else {
                hourlyDiv.classList.add('show');
                expandIcon.classList.add('expanded');
            }
        }
        
        // Show 24-hour forecast in modal popup
        function show24HourForecast() {
            const modal = document.getElementById('hourlyModal');
            if (modal) {
                modal.classList.add('show');
                // Prevent body scroll when modal is open
                document.body.style.overflow = 'hidden';
            }
        }
        
        // Close 24-hour forecast modal
        function closeHourlyModal() {
            const modal = document.getElementById('hourlyModal');
            if (modal) {
                modal.classList.remove('show');
                // Restore body scroll
                document.body.style.overflow = '';
            }
        }
        
        // Close modal when clicking outside
        function handleModalClick(event) {
            if (event.target.id === 'hourlyModal') {
                closeHourlyModal();
            }
        }
        
        // Get weather description from code
        function getWeatherDescription(code) {
            const descriptions = {
                0: 'Clear sky', 1: 'Mainly clear', 2: 'Partly cloudy', 3: 'Overcast',
                45: 'Fog', 48: 'Rime fog',
                51: 'Light drizzle', 53: 'Drizzle', 55: 'Dense drizzle',
                61: 'Slight rain', 63: 'Rain', 65: 'Heavy rain',
                71: 'Slight snow', 73: 'Snow', 75: 'Heavy snow',
                80: 'Rain showers', 81: 'Heavy showers', 82: 'Violent showers',
                95: 'Thunderstorm', 96: 'Thunderstorm with hail', 99: 'Severe thunderstorm'
            };
            return descriptions[code] || 'Unknown';
        }
        
        // Get weather icon emoji from code
        function getWeatherIcon(code) {
            const icons = {
                0: '‚òÄÔ∏è',   // Clear sky
                1: 'üå§Ô∏è',   // Mainly clear
                2: '‚õÖ',   // Partly cloudy
                3: '‚òÅÔ∏è',   // Overcast
                45: 'üå´Ô∏è',  // Fog
                48: 'üå´Ô∏è',  // Rime fog
                51: 'üå¶Ô∏è',  // Light drizzle
                53: 'üåßÔ∏è',  // Drizzle
                55: 'üåßÔ∏è',  // Dense drizzle
                61: 'üåßÔ∏è',  // Slight rain
                63: 'üåßÔ∏è',  // Rain
                65: '‚õàÔ∏è',  // Heavy rain
                71: 'üå®Ô∏è',  // Slight snow
                73: '‚ùÑÔ∏è',  // Snow
                75: '‚ùÑÔ∏è',  // Heavy snow
                80: 'üå¶Ô∏è',  // Rain showers
                81: '‚õàÔ∏è',  // Heavy showers
                82: '‚õàÔ∏è',  // Violent showers
                95: '‚õàÔ∏è',  // Thunderstorm
                96: '‚õàÔ∏è',  // Thunderstorm with hail
                99: '‚õàÔ∏è'   // Severe thunderstorm
            };
            return icons[code] || 'üå§Ô∏è';
        }
        
        // Get wind direction
        function getWindDirection(degrees) {
            const dirs = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
            return dirs[Math.round(degrees / 22.5) % 16];
        }
        
        // Calculate moon phase from date
        function getMoonPhase(date = new Date()) {
            // Calculate days since known new moon (Jan 6, 2000)
            const referenceDate = new Date(2000, 0, 6, 18, 14);
            const daysSince = (date - referenceDate) / (1000 * 60 * 60 * 24);
            
            // Moon cycle is 29.53 days
            const lunarCycle = 29.53058867;
            const phase = (daysSince % lunarCycle) / lunarCycle;
            
            return phase;
        }
        
        // Get moon phase name and emoji
        function getMoonPhaseInfo(phase) {
            if (phase < 0.03 || phase > 0.97) {
                return { name: 'New Moon', emoji: 'üåë', illumination: 0 };
            } else if (phase < 0.22) {
                return { name: 'Waxing Crescent', emoji: 'üåí', illumination: Math.round(phase * 100) };
            } else if (phase < 0.28) {
                return { name: 'First Quarter', emoji: 'üåì', illumination: 50 };
            } else if (phase < 0.47) {
                return { name: 'Waxing Gibbous', emoji: 'üåî', illumination: Math.round(phase * 100) };
            } else if (phase < 0.53) {
                return { name: 'Full Moon', emoji: 'üåï', illumination: 100 };
            } else if (phase < 0.72) {
                return { name: 'Waning Gibbous', emoji: 'üåñ', illumination: Math.round((1 - phase) * 100) };
            } else if (phase < 0.78) {
                return { name: 'Last Quarter', emoji: 'üåó', illumination: 50 };
            } else {
                return { name: 'Waning Crescent', emoji: 'üåò', illumination: Math.round((1 - phase) * 100) };
            }
        }
        
        // Format time from ISO string
        function formatTime(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            const hours = date.getHours();
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours % 12 || 12;
            return `${displayHours}:${minutes} ${ampm}`;
        }
        
        // Calculate moonrise and moonset (approximate)
        function calculateMoonTimes(date, latitude, longitude) {
            const phase = getMoonPhase(date);
            
            // Simplified calculation based on moon phase
            // Full moon rises around sunset, new moon rises around sunrise
            const dayOffset = phase * 24; // Hours offset from sunrise
            
            const moonriseHour = (6 + dayOffset) % 24; // Approximate moonrise
            const moonsetHour = (moonriseHour + 12) % 24; // Approximate moonset
            
            const moonrise = new Date(date);
            moonrise.setHours(Math.floor(moonriseHour), Math.floor((moonriseHour % 1) * 60), 0);
            
            const moonset = new Date(date);
            moonset.setHours(Math.floor(moonsetHour), Math.floor((moonsetHour % 1) * 60), 0);
            
            return {
                moonrise: moonrise.toISOString(),
                moonset: moonset.toISOString()
            };
        }
        
        // Generate detailed weather warnings based on conditions
        function generateWarnings(current) {
            const warnings = [];
            
            // WIND WARNINGS
            if (current.wind_speed_10m >= 75) {
                warnings.push({
                    level: 'Level 10 (Red)',
                    color: 'warning-red',
                    type: 'Destructive Winds - EXTREME DANGER',
                    message: `Destructive winds ${Math.round(current.wind_speed_10m)} km/h. Catastrophic damage expected. Widespread destruction of structures. TAKE SHELTER IMMEDIATELY. Do NOT go outside.`
                });
            } else if (current.wind_speed_10m >= 60) {
                warnings.push({
                    level: 'Level 8 (Orange)',
                    color: 'warning-orange',
                    type: 'Damaging Winds - HIGH DANGER',
                    message: `Damaging winds ${Math.round(current.wind_speed_10m)} km/h. Trees may be uprooted. Structural damage possible. Stay indoors away from windows.`
                });
            } else if (current.wind_speed_10m >= 50) {
                warnings.push({
                    level: 'Level 6 (Yellow)',
                    color: 'warning-yellow',
                    type: 'Severe Wind Warning',
                    message: `Severe winds ${Math.round(current.wind_speed_10m)} km/h. Flying debris and falling branches likely. Difficult driving conditions. Avoid travel if possible.`
                });
            } else if (current.wind_speed_10m >= 40) {
                warnings.push({
                    level: 'Level 4 (Yellow)',
                    color: 'warning-yellow',
                    type: 'Strong Wind Warning',
                    message: `Strong winds ${Math.round(current.wind_speed_10m)} km/h. Secure loose objects. Drive carefully, especially high-profile vehicles.`
                });
            }
            
            // EXTREME HEAT WARNINGS
            if (current.temperature_2m >= 43) {
                warnings.push({
                    level: 'Level 10 (Red)',
                    color: 'warning-red',
                    type: 'Extreme Heat - CATASTROPHIC',
                    message: `Catastrophic heat ${Math.round(current.temperature_2m)}¬∞C. Widespread heat stroke. Elderly and vulnerable at extreme risk. Infrastructure failure possible. Stay indoors with AC.`
                });
            } else if (current.temperature_2m >= 40) {
                warnings.push({
                    level: 'Level 8 (Orange)',
                    color: 'warning-orange',
                    type: 'Extreme Heat - SEVERE',
                    message: `Extreme heat ${Math.round(current.temperature_2m)}¬∞C. Heat stroke highly likely. Vulnerable groups at high risk. Avoid all outdoor activity. Drink plenty of water.`
                });
            } else if (current.temperature_2m >= 38) {
                warnings.push({
                    level: 'Level 6 (Yellow)',
                    color: 'warning-yellow',
                    type: 'Extreme Heat Warning',
                    message: `Extreme heat ${Math.round(current.temperature_2m)}¬∞C. Heat exhaustion and cramps likely. Stay hydrated. Limit outdoor exposure.`
                });
            } else if (current.temperature_2m >= 35) {
                warnings.push({
                    level: 'Level 4 (Yellow)',
                    color: 'warning-yellow',
                    type: 'Heat Advisory',
                    message: `Very hot conditions ${Math.round(current.temperature_2m)}¬∞C. Heat exhaustion possible. Drink plenty of water. Take breaks in shade.`
                });
            }
            
            // HEAT INDEX WARNING
            if (current.apparent_temperature >= 45 && current.apparent_temperature > current.temperature_2m + 3) {
                warnings.push({
                    level: 'Level 8 (Orange)',
                    color: 'warning-orange',
                    type: 'Dangerous Heat Index',
                    message: `Feels like ${Math.round(current.apparent_temperature)}¬∞C. Extreme heat stress due to humidity. Heat exhaustion imminent with prolonged exposure.`
                });
            }
            
            // COLD WARNINGS
            if (current.temperature_2m <= -10) {
                warnings.push({
                    level: 'Level 9 (Orange)',
                    color: 'warning-orange',
                    type: 'Extreme Cold - SEVERE',
                    message: `Dangerously cold ${Math.round(current.temperature_2m)}¬∞C. Frostbite in minutes. Life-threatening hypothermia. Water pipes may burst. Stay indoors.`
                });
            } else if (current.temperature_2m <= 0) {
                warnings.push({
                    level: 'Level 6 (Yellow)',
                    color: 'warning-yellow',
                    type: 'Freezing Conditions',
                    message: `Freezing ${Math.round(current.temperature_2m)}¬∞C. Icy roads. Burst pipes possible. Protect vulnerable people and plants.`
                });
            } else if (current.temperature_2m <= 5) {
                warnings.push({
                    level: 'Level 3 (Yellow)',
                    color: 'warning-yellow',
                    type: 'Cold Weather Advisory',
                    message: `Very cold ${Math.round(current.temperature_2m)}¬∞C. Frost likely overnight. Dress warmly.`
                });
            }
            
            // SEVERE WEATHER WARNINGS (based on weather codes)
            if ([95, 96, 99].includes(current.weather_code)) {
                if (current.weather_code === 99) {
                    warnings.push({
                        level: 'Level 9 (Orange)',
                        color: 'warning-red',
                        type: '‚ö° Severe Thunderstorm - EXTREME',
                        message: 'Violent thunderstorms with very large hail. LIFE-THREATENING LIGHTNING. Severe damage to property and crops. Seek substantial shelter immediately. Check ‚ö°Lightning radar layer for real-time strike locations.'
                    });
                } else if (current.weather_code === 96) {
                    warnings.push({
                        level: 'Level 7 (Orange)',
                        color: 'warning-orange',
                        type: '‚ö° Severe Thunderstorm with Hail',
                        message: 'Severe thunderstorms with large hail. DANGEROUS LIGHTNING activity. Damage to vehicles and structures. Take shelter now. Monitor ‚ö°Lightning radar for active strikes.'
                    });
                } else {
                    warnings.push({
                        level: 'Level 6 (Yellow)',
                        color: 'warning-yellow',
                        type: '‚ö° Severe Thunderstorm Warning',
                        message: 'Severe thunderstorms approaching. Active lightning, heavy rain, possible hail and strong winds. Move indoors away from windows. View ‚ö°Lightning radar layer to track storm cells.'
                    });
                }
            } else if (current.weather_code === 82) {
                warnings.push({
                    level: 'Level 5 (Yellow)',
                    color: 'warning-yellow',
                    type: 'Violent Rain Showers',
                    message: 'Violent rain showers. Flash flooding in low-lying areas. Avoid rivers and streams. Drive with extreme caution.'
                });
            } else if (current.weather_code === 81) {
                warnings.push({
                    level: 'Level 4 (Yellow)',
                    color: 'warning-yellow',
                    type: 'Heavy Rain Showers',
                    message: 'Heavy rain expected. Minor flooding possible. Roads may be slippery. Reduce speed.'
                });
            }
            
            // SNOW/ICE WARNINGS
            if ([71, 73, 75].includes(current.weather_code)) {
                if (current.weather_code === 75) {
                    warnings.push({
                        level: 'Level 9 (Orange)',
                        color: 'warning-orange',
                        type: 'Heavy Snow - SEVERE',
                        message: 'Heavy snowfall. Major travel disruption. Blizzard conditions. Road closures. Do not travel.'
                    });
                } else if (current.weather_code === 73) {
                    warnings.push({
                        level: 'Level 6 (Yellow)',
                        color: 'warning-yellow',
                        type: 'Significant Snow',
                        message: 'Significant snowfall. Hazardous travel. Icy roads. Travel only if essential.'
                    });
                } else {
                    warnings.push({
                        level: 'Level 3 (Yellow)',
                        color: 'warning-yellow',
                        type: 'Light Snow',
                        message: 'Light snow. Slippery roads possible. Reduce speed and increase following distance.'
                    });
                }
            }
            
            // FOG WARNING
            if ([45, 48].includes(current.weather_code)) {
                warnings.push({
                    level: 'Level 4 (Yellow)',
                    color: 'warning-yellow',
                    type: 'Dense Fog',
                    message: 'Dense fog. Visibility severely reduced. Hazardous driving. Use fog lights. Allow extra travel time.'
                });
            }
            
            // FIRE DANGER (combined conditions)
            if (current.relative_humidity_2m <= 20 && current.temperature_2m >= 32 && current.wind_speed_10m >= 30) {
                warnings.push({
                    level: 'Level 9 (Orange)',
                    color: 'warning-red',
                    type: 'Extreme Fire Danger',
                    message: `Critical fire weather. Very hot (${Math.round(current.temperature_2m)}¬∞C), extremely dry (${current.relative_humidity_2m}% humidity), strong winds (${Math.round(current.wind_speed_10m)} km/h). NO outdoor burning. Fires spread explosively.`
                });
            } else if (current.relative_humidity_2m <= 30 && current.temperature_2m >= 30 && current.wind_speed_10m >= 25) {
                warnings.push({
                    level: 'Level 6 (Yellow)',
                    color: 'warning-yellow',
                    type: 'High Fire Danger',
                    message: 'High fire danger. Hot, dry, windy conditions favor rapid fire spread. Avoid open flames. Monitor fire alerts.'
                });
            }
            
            return warnings;
        }
        
        // Share weather via WhatsApp
        function shareWeather() {
            if (!currentLocation || !currentLocation.weather) return;
            
            const current = currentLocation.weather;
            const warnings = generateWarnings(current);
            const precipProb = currentLocation.precipProb || 0;
            
            let message = `‚ö†Ô∏è StormWarn Weather Update\n\n`;
            message += `üìç ${currentLocation.name}\n`;
            message += `${getWeatherIcon(current.weather_code)} ${Math.round(current.temperature_2m)}¬∞C - ${getWeatherDescription(current.weather_code)}\n`;
            message += `üí® Wind: ${Math.round(current.wind_speed_10m)} km/h ${getWindDirection(current.wind_direction_10m)}\n`;
            message += `üíß Humidity: ${current.relative_humidity_2m}%\n`;
            message += `‚òî Precipitation: ${precipProb}% chance\n`;
            message += `üå°Ô∏è Feels like: ${Math.round(current.apparent_temperature)}¬∞C\n`;
            
            if (warnings.length > 0) {
                message += `\n‚ö†Ô∏è ACTIVE WARNINGS:\n`;
                warnings.forEach(warning => {
                    message += `\n${warning.level} - ${warning.type}\n`;
                    message += `${warning.message}\n`;
                });
            } else {
                message += `\n‚úÖ No active warnings\n`;
            }
            
            message += `\nView live updates: ${window.location.href}`;
            
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }
        
        // Fetch and display weather
        async function loadWeather(lat, lon, customName = null) {
            try {
                console.log(`StormWarn: Fetching weather for ${lat}, ${lon}`);
                
                app.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading weather data...</p>
                    </div>
                `;
                
                let locationName;
                
                // Get location name
                if (customName) {
                    locationName = customName;
                    console.log('StormWarn: Using custom location name:', locationName);
                } else {
                    try {
                        console.log('StormWarn: Fetching location name from BigDataCloud...');
                        const geoRes = await fetch(
                            `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`
                        );
                        if (!geoRes.ok) {
                            throw new Error(`Geocoding failed: ${geoRes.status}`);
                        }
                        const geoData = await geoRes.json();
                        locationName = `${geoData.city || geoData.locality || 'Unknown'}, ${geoData.principalSubdivision || geoData.countryName || ''}`;
                        console.log('StormWarn: Location name retrieved:', locationName);
                    } catch (geoError) {
                        console.warn('StormWarn: Geocoding failed, using coordinates:', geoError);
                        locationName = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                    }
                }
                
                // Get weather data
                console.log('StormWarn: Fetching weather data from Open-Meteo...');
                const weatherRes = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m,wind_direction_10m,pressure_msl&hourly=temperature_2m,precipitation_probability,weather_code,wind_speed_10m&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_probability_max,wind_speed_10m_max,sunrise,sunset,daylight_duration,sunshine_duration&timezone=auto&forecast_days=14`
                );
                
                if (!weatherRes.ok) {
                    throw new Error(`Weather API returned status ${weatherRes.status}: ${weatherRes.statusText}`);
                }
                
                console.log('StormWarn: Parsing weather response...');
                const weather = await weatherRes.json();
                
                if (!weather || !weather.current) {
                    throw new Error('Invalid weather data received from API');
                }
                
                const current = weather.current;
                console.log('StormWarn: Current weather data:', current);
                
                // Get current hour's precipitation probability
                const currentHour = new Date().getHours();
                const precipProb = weather.hourly && weather.hourly.precipitation_probability 
                    ? weather.hourly.precipitation_probability[currentHour] || 0 
                    : 0;
                
                // Store current location and weather data
                currentLocation = { lat, lon, name: locationName, weather: current, precipProb };
                
                console.log('StormWarn: Weather data loaded successfully');
                
                // Generate warnings
                const warnings = generateWarnings(current);
                
                // Check if we should send push notification for severe weather
                checkSevereWeather(warnings);
                
                // Display warnings
                let warningsHTML = '';
                if (warnings.length > 0) {
                    warningsHTML = `
                        <div class="warnings-card">
                            <div class="warnings-header">
                                ‚ö†Ô∏è Active Warnings
                            </div>
                            ${warnings.map(warning => `
                                <div class="warning-item ${warning.color}">
                                    <div class="warning-level">${warning.level}</div>
                                    <div class="warning-type">${warning.type}</div>
                                    <div class="warning-message">${warning.message}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    warningsHTML = `
                        <div class="warnings-card no-warnings">
                            <div class="no-warnings-icon">‚úÖ</div>
                            <div style="font-weight: 600; font-size: 1.1rem;">No Active Warnings</div>
                            <div style="color: #666; margin-top: 0.5rem;">All clear in your area. Check back regularly for updates.</div>
                        </div>
                    `;
                }
                
                // Calculate moon phase and times
                const moonPhase = getMoonPhase(new Date());
                const moonInfo = getMoonPhaseInfo(moonPhase);
                const moonTimes = calculateMoonTimes(new Date(), lat, lon);
                
                // Get today's sunrise/sunset from daily data
                const todaySunrise = weather.daily && weather.daily.sunrise ? weather.daily.sunrise[0] : null;
                const todaySunset = weather.daily && weather.daily.sunset ? weather.daily.sunset[0] : null;
                
                // Display weather
                app.innerHTML = warningsHTML + `
                    <div class="card">
                        <div class="location">${locationName}</div>
                        <div class="temperature">${Math.round(current.temperature_2m)}¬∞C</div>
                        <div class="condition">
                            <span class="weather-icon">${getWeatherIcon(current.weather_code)}</span>
                            <span>${getWeatherDescription(current.weather_code)}</span>
                        </div>
                        
                        <div class="details">
                            <div class="detail">
                                <div class="detail-label">Wind</div>
                                <div class="detail-value">
                                    ${Math.round(current.wind_speed_10m)} km/h ${getWindDirection(current.wind_direction_10m)}
                                </div>
                            </div>
                            <div class="detail">
                                <div class="detail-label">Humidity</div>
                                <div class="detail-value">${current.relative_humidity_2m}%</div>
                            </div>
                            <div class="detail">
                                <div class="detail-label">Precipitation</div>
                                <div class="detail-value">${precipProb}% chance</div>
                            </div>
                            <div class="detail">
                                <div class="detail-label">Feels Like</div>
                                <div class="detail-value">${Math.round(current.apparent_temperature)}¬∞C</div>
                            </div>
                            <div class="detail">
                                <div class="detail-label">Pressure</div>
                                <div class="detail-value">${Math.round(current.pressure_msl)} hPa</div>
                            </div>
                        </div>
                        
                        <div class="details" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #f0f0f0;">
                            <div class="detail">
                                <div class="detail-label">‚òÄÔ∏è Sunrise</div>
                                <div class="detail-value">${formatTime(todaySunrise)}</div>
                            </div>
                            <div class="detail">
                                <div class="detail-label">üåÖ Sunset</div>
                                <div class="detail-value">${formatTime(todaySunset)}</div>
                            </div>
                            <div class="detail">
                                <div class="detail-label">üåô Moonrise</div>
                                <div class="detail-value">${formatTime(moonTimes.moonrise)}</div>
                            </div>
                            <div class="detail">
                                <div class="detail-label">üåô Moonset</div>
                                <div class="detail-value">${formatTime(moonTimes.moonset)}</div>
                            </div>
                            <div class="detail">
                                <div class="detail-label">${moonInfo.emoji} Moon Phase</div>
                                <div class="detail-value">${moonInfo.name}</div>
                            </div>
                        </div>
                        
                        <div class="share-section">
                            <button class="share-btn" onclick="shareWeather()">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                                </svg>
                                Share via WhatsApp
                            </button>
                            <button class="hourly-btn" onclick="show24HourForecast()">
                                üïê View 24-Hour Forecast
                            </button>
                        </div>
                    </div>
                `;
                
                // Add radar map section IMMEDIATELY after current weather
                const radarHTML = `
                    <div class="radar-card">
                        <div class="radar-header">
                            üåßÔ∏è Live Weather Radar
                        </div>
                        
                        <div class="radar-controls">
                            <button class="radar-btn active" onclick="switchRadarLayer('rain')">
                                üíß Precipitation
                            </button>
                            <button class="radar-btn" onclick="switchRadarLayer('clouds')">
                                ‚òÅÔ∏è Clouds
                            </button>
                            <button class="radar-btn" onclick="switchRadarLayer('wind')">
                                üí® Wind
                            </button>
                            <button class="radar-btn" onclick="switchRadarLayer('temp')">
                                üå°Ô∏è Temperature
                            </button>
                            <button class="radar-btn" onclick="switchRadarLayer('lightning')">
                                ‚ö° Lightning
                            </button>
                        </div>
                        
                        <div class="radar-container">
                            <iframe 
                                id="radarMap"
                                class="radar-map"
                                frameborder="0"
                                loading="lazy"
                                allow="geolocation"
                            ></iframe>
                        </div>
                        
                        <div class="radar-info">
                            ‚ÑπÔ∏è Live weather radar powered by Windy. View precipitation, clouds, wind, temperature, and real-time lightning strikes. Drag to pan, scroll to zoom. Data updates every 10 minutes.
                        </div>
                    </div>
                `;
                
                app.innerHTML += radarHTML;
                
                // Initialize radar
                updateRadarMap();
                
                // Add 10-day forecast AT THE BOTTOM
                const daily = weather.daily;
                const hourly = weather.hourly;
                
                if (daily && daily.time && hourly && hourly.time) {
                    const forecastDays = daily.time.slice(0, 10); // Get first 10 days
                    const currentHour = new Date().getHours();
                    
                    const forecastHTML = `
                        <div class="forecast-card">
                            <div class="forecast-header">üìÖ 10-Day Forecast</div>
                            <div class="forecast-list">
                                ${forecastDays.map((date, index) => {
                                    const isToday = index === 0;
                                    const dayDate = new Date(date);
                                    const dayName = isToday ? 'Today' : dayDate.toLocaleDateString('en-US', { weekday: 'long' });
                                    const dateStr = dayDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                    
                                    const weatherCode = daily.weather_code[index];
                                    const tempMax = Math.round(daily.temperature_2m_max[index]);
                                    const tempMin = Math.round(daily.temperature_2m_min[index]);
                                    const precipSum = daily.precipitation_sum ? daily.precipitation_sum[index] : 0;
                                    const precipProb = daily.precipitation_probability_max ? daily.precipitation_probability_max[index] : 0;
                                    const windMax = daily.wind_speed_10m_max ? Math.round(daily.wind_speed_10m_max[index]) : 0;
                                    
                                    let dayHTML = `
                                        <div class="forecast-day ${isToday ? 'today' : ''}" ${isToday ? 'onclick="toggleHourlyForecast()"' : ''}>
                                            <div class="forecast-date">
                                                <div style="font-weight: 700;">${dayName}</div>
                                                <div style="font-size: 0.9rem; color: #666;">${dateStr}</div>
                                            </div>
                                            <div class="forecast-icon-day">${getWeatherIcon(weatherCode)}</div>
                                            <div class="forecast-condition">
                                                ${getWeatherDescription(weatherCode)}
                                                ${isToday ? '<span class="expand-icon" id="expandIcon">‚ñº</span>' : ''}
                                            </div>
                                            <div class="forecast-temp">
                                                <span class="forecast-temp-high">${tempMax}¬∞</span> / 
                                                <span class="forecast-temp-low">${tempMin}¬∞</span>
                                            </div>
                                            <div>
                                                ${precipProb > 0 ? `<div class="forecast-precip">üíß ${precipProb}% chance</div>` : '<div style="color: #999;">No rain</div>'}
                                                ${windMax > 30 ? `<div style="font-size: 0.9rem; color: #666;">üí® ${windMax} km/h</div>` : ''}
                                            </div>
                                        </div>
                                    `;
                                    
                                    // Add hourly forecast for today
                                    if (isToday && hourly && hourly.time) {
                                        // Get next 24 hours
                                        const next24Hours = hourly.time.slice(currentHour, currentHour + 24);
                                        
                                        dayHTML += `
                                            <div class="hourly-forecast" id="hourlyForecast">
                                                <div class="hourly-header">
                                                    üïê Hourly Forecast (Next 24 Hours)
                                                </div>
                                                <div class="hourly-list">
                                                    ${next24Hours.map((time, hIndex) => {
                                                        const hourIndex = currentHour + hIndex;
                                                        const hour = new Date(time).getHours();
                                                        const isCurrent = hIndex === 0;
                                                        const temp = Math.round(hourly.temperature_2m[hourIndex]);
                                                        const precipProb = hourly.precipitation_probability ? hourly.precipitation_probability[hourIndex] : 0;
                                                        const weatherCode = hourly.weather_code ? hourly.weather_code[hourIndex] : 0;
                                                        const windSpeed = hourly.wind_speed_10m ? Math.round(hourly.wind_speed_10m[hourIndex]) : 0;
                                                        
                                                        const timeStr = hour === 0 ? '12 AM' : 
                                                                       hour < 12 ? `${hour} AM` : 
                                                                       hour === 12 ? '12 PM' : 
                                                                       `${hour - 12} PM`;
                                                        
                                                        return `
                                                            <div class="hourly-item ${isCurrent ? 'current' : ''}">
                                                                <div class="hourly-time">
                                                                    ${timeStr}${isCurrent ? ' (Now)' : ''}
                                                                </div>
                                                                <div class="hourly-icon">${getWeatherIcon(weatherCode)}</div>
                                                                <div class="hourly-condition">${getWeatherDescription(weatherCode)}</div>
                                                                <div class="hourly-temp">${temp}¬∞C</div>
                                                                <div class="hourly-details">
                                                                    ${precipProb > 0 ? `üíß ${precipProb}%` : ''} 
                                                                    ${windSpeed > 0 ? `üí® ${windSpeed} km/h` : ''}
                                                                </div>
                                                            </div>
                                                        `;
                                                    }).join('')}
                                                </div>
                                            </div>
                                        `;
                                    }
                                    
                                    return dayHTML;
                                }).join('')}
                            </div>
                        </div>
                    `;
                    
                    app.innerHTML += forecastHTML;
                    
                    // Build 24-hour forecast modal (now that we have confirmed hourly data exists)
                    const currentHourForModal = new Date().getHours();
                    const next24Hours = hourly.time.slice(currentHourForModal, currentHourForModal + 24);
                    
                    const modalHTML = `
                        <div class="modal-overlay" id="hourlyModal" onclick="handleModalClick(event)">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <div class="modal-title">
                                        üïê 24-Hour Forecast
                                    </div>
                                    <button class="modal-close" onclick="closeHourlyModal()" aria-label="Close">
                                        √ó
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div class="modal-hourly-list">
                                        ${next24Hours.map((time, hIndex) => {
                                            const hourIndex = currentHourForModal + hIndex;
                                            const hour = new Date(time).getHours();
                                            const isCurrent = hIndex === 0;
                                            const temp = Math.round(hourly.temperature_2m[hourIndex]);
                                            const precipProb = hourly.precipitation_probability ? hourly.precipitation_probability[hourIndex] : 0;
                                            const weatherCode = hourly.weather_code ? hourly.weather_code[hourIndex] : 0;
                                            const windSpeed = hourly.wind_speed_10m ? Math.round(hourly.wind_speed_10m[hourIndex]) : 0;
                                            
                                            const timeStr = hour === 0 ? '12 AM' : 
                                                           hour < 12 ? `${hour} AM` : 
                                                           hour === 12 ? '12 PM' : 
                                                           `${hour - 12} PM`;
                                            
                                            return `
                                                <div class="modal-hourly-item ${isCurrent ? 'current' : ''}">
                                                    <div class="modal-hour-time">
                                                        ${timeStr}${isCurrent ? ' (Now)' : ''}
                                                    </div>
                                                    <div class="modal-hour-icon">${getWeatherIcon(weatherCode)}</div>
                                                    <div class="modal-hour-condition">${getWeatherDescription(weatherCode)}</div>
                                                    <div class="modal-hour-temp">${temp}¬∞C</div>
                                                    <div class="modal-hour-details">
                                                        ${precipProb > 0 ? `üíß ${precipProb}% rain` : ''} 
                                                        ${windSpeed > 0 ? `üí® ${windSpeed} km/h` : ''}
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    app.innerHTML += modalHTML;
                }
                
                updateSaveButton();
                renderSavedLocations();
                
            } catch (error) {
                console.error('StormWarn: Error loading weather:', error);
                console.error('StormWarn: Error stack:', error.stack);
                
                app.innerHTML = `
                    <div class="card error">
                        <h2>‚ö†Ô∏è Failed to load weather data</h2>
                        <p style="color: #666; margin: 1rem 0;">${error.message}</p>
                        <p style="font-size: 0.9rem; color: #999; margin-bottom: 1rem;">
                            Please check your internet connection and try again.
                        </p>
                        <button class="btn" onclick="init()" style="background: #0ea5e9; color: white; padding: 0.75rem 2rem; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600;">
                            üîÑ Retry
                        </button>
                    </div>
                `;
            }
        }
        
        // Initialize app
        function init() {
            console.log('StormWarn: Initializing...');
            
            loadSavedLocations();
            
            // Try to get user location, fallback to Cape Town
            if (navigator.geolocation) {
                console.log('StormWarn: Requesting geolocation...');
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log('StormWarn: Got user location');
                        loadWeather(position.coords.latitude, position.coords.longitude);
                    },
                    (error) => {
                        console.log('StormWarn: Geolocation failed, using Cape Town');
                        loadWeather(-33.9249, 18.4241);
                    },
                    { timeout: 10000 }
                );
            } else {
                console.log('StormWarn: Geolocation not available, using Cape Town');
                loadWeather(-33.9249, 18.4241);
            }
        }
        
        // Start the app
        init();
    </script>
</body>
</html>
